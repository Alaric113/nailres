rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =============================================
    //           輔助函式 (Helper Functions)
    // =============================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // 真正的管理員 (非設計師身分，純管理)
    function isTrulyAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    // 管理設計師 (可管理所有設計師，且本身為設計師)
    function isManager() {
      return isAuthenticated() && getUserRole() == 'manager';
    }

    // 普通設計師 (僅可管理自己的工作)
    function isDesigner() {
      return isAuthenticated() && getUserRole() == 'designer';
    }
    
    // 擁有全部設計師管理權限 (管理員或管理設計師)
    function canAdminAllDesigners() {
      return isTrulyAdmin() || isManager();
    }

    // 任何員工角色 (管理員、管理設計師、設計師)
    function isStaff() {
      return isTrulyAdmin() || isManager() || isDesigner();
    }

    // =============================================
    //           集合規則 (Collection Rules)
    // =============================================

    // 使用者集合
    match /users/{userId} {
      // 任何員工可讀取所有使用者資料 (用於查看客戶資料、連結設計師檔案)；使用者僅能讀取自己的
      allow get: if isAuthenticated() && (isStaff() || request.auth.uid == userId);
      // 任何員工可列出所有使用者
      allow list: if isStaff();
      // 使用者可建立自己的文件，但角色必須是 'user'
      allow create: if isAuthenticated() && request.auth.uid == userId && request.resource.data.role == 'user';
      // 使用者可更新自己除了 'role' 以外的資料；管理員/管理設計師可更新任何資料，包括修改角色
      allow update: if (isAuthenticated() && request.auth.uid == userId && !('role' in request.resource.data)) || canAdminAllDesigners();
      // 不允許刪除使用者文件
      allow delete: if false;

      // 使用者優惠券子集合
      match /userCoupons/{userCouponId} {
        allow read, list: if isAuthenticated() && (request.auth.uid == userId || isStaff());
        allow update: if isAuthenticated() && (request.auth.uid == userId || isStaff());
        allow create: if isStaff(); // 允許員工發放
        allow delete: if canAdminAllDesigners(); // 僅管理員/管理設計師可刪除
      }
    }

    // 設計師集合
    match /designers/{designerId} {
      // 所有人可讀取設計師列表 (預約頁面需要)
      allow read: if true;
      // 僅管理員/管理設計師可建立或刪除設計師檔案
      allow create, delete: if canAdminAllDesigners();
      // 更新規則：
      // 1. 管理員/管理設計師可以更新任何欄位
      // 2. 普通設計師只能更新「連結到自己帳號」的檔案，且不能修改 linkedUserId 本身 (防止竊取其他檔案)
      //    也不能修改 bookingDeadline (這是 Manager-level 設定)
      allow update: if canAdminAllDesigners() || (
        isDesigner() && 
        resource.data.linkedUserId == request.auth.uid && 
        request.resource.data.linkedUserId == resource.data.linkedUserId &&
        !('bookingDeadline' in request.resource.data)
      );
    }
    
    // 設計師的營業時間子集合
    match /designers/{designerId}/businessHours/{dateId} {
      // 任何人可讀取 (預約介面需要)
      allow read: if true;
      // 管理員/管理設計師可更新任何設計師的營業時間
      // 普通設計師只能更新自己檔案下的營業時間
      allow write: if canAdminAllDesigners() || (isDesigner() && get(/databases/$(database)/documents/designers/$(designerId)).data.linkedUserId == request.auth.uid);
    }

    // 服務項目集合
    match /services/{serviceId} {
      allow read: if true;
      allow write: if canAdminAllDesigners(); // 服務項目由管理員/管理設計師統一管理
    }

    // 服務分類集合
    match /serviceCategories/{categoryId} {
      allow read: if true;
      allow write: if canAdminAllDesigners();
    }

    // 預約集合
    match /bookings/{bookingId} {
      // 任何員工可讀取所有預約；使用者僅能讀取自己的
      allow get: if isAuthenticated() && (isStaff() || resource.data.userId == request.auth.uid);
      allow list: if isStaff(); // 前端過濾
      
      // 使用者僅能為自己建立預約；員工可為客戶建立
      allow create: if isAuthenticated() && (request.resource.data.userId == request.auth.uid || isStaff());
      
      // 使用者可取消自己的預約；員工可更新預約狀態；使用者可填寫評價
      allow update: if isAuthenticated() && (
        (resource.data.userId == request.auth.uid && request.resource.data.status == 'cancelled') || 
        (resource.data.userId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['customerFeedback'])) ||
        isStaff()
      );
      
      allow delete: if false;
    }

    // 全域營業時間集合 (若仍有使用，由管理員/管理設計師管理)
    match /businessHours/{dateId} {
      allow read: if isAuthenticated();
      allow write: if canAdminAllDesigners();
    }
    
    // 優惠券
    match /coupons/{couponId} {
      allow read: if isAuthenticated();
      allow write: if canAdminAllDesigners();
    }
    
    // 點數紀錄
    match /loyaltyPointLogs/{logId} {
      allow create: if isStaff(); // 允許員工操作點數
      allow read: if isStaff() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow update, delete: if false;
    }

    match /banners/{bannerId} {
      allow read: if true;
      allow write: if canAdminAllDesigners();
    }

    match /portfolioItems/{itemId} {
      allow read: if true;
      allow write: if isStaff(); // 任何員工可上傳作品
    }

    match /schedules/{scheduleId} {
      allow read: if true;
      allow write: if false;
    }

    match /settings/{settingId} {
      allow read, write: if canAdminAllDesigners();
    }

    match /globals/{document=**} {
      allow read: if true;
      allow write: if canAdminAllDesigners();
    }

    // Season Passes
    match /season_passes/{passId} {
      allow read: if true; // Publicly visible
      allow write: if isStaff(); // Admins/Staff can manage
    }

    // Public Reviews (Derived from bookings)
    match /public_reviews/{reviewId} {
      allow read: if true;
      allow create, update: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Alternatively, stricter: verify the booking exists and belongs to user, but that needs get().
    }

    // 問題回報/待辦事項 (含評論子集合)
    match /feedback/{feedbackId}/{document=**} {
      allow read, write: if isStaff();
    }
  }
}
