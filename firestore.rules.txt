rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =============================================
    //           輔助函式 (Helper Functions)
    // =============================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      // 確保使用者已登入，並且其在 'users' 集合中的文件 'role' 欄位為 'admin'
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // =============================================
    //           集合規則 (Collection Rules)
    // =============================================

    // 使用者集合
    match /users/{userId} {
      // 管理員可讀取任何使用者資料；使用者僅能讀取自己的
      allow get: if isAuthenticated() && (isAdmin() || request.auth.uid == userId);
      // 僅管理員可列出所有使用者
      allow list: if isAdmin();
      // 使用者可建立自己的文件，但角色必須是 'user'
      allow create: if isAuthenticated() && request.auth.uid == userId && request.resource.data.role == 'user';
      // 使用者可更新自己除了 'role' 以外的資料；管理員可更新任何資料
      allow update: if (isAuthenticated() && request.auth.uid == userId && !('role' in request.resource.data)) || isAdmin();
      // 不允許刪除使用者文件
      allow delete: if false;

      // 使用者優惠券子集合 (正確的位置)
      match /userCoupons/{userCouponId} {
        // 使用者可以讀取自己的優惠券列表
        allow read, list: if isAuthenticated() && request.auth.uid == userId;
        // 使用者可以使用優惠券 (更新 isUsed 欄位)
        allow update: if isAuthenticated() && request.auth.uid == userId;
        // 只有管理員(透過後端)可以發放優惠券
        allow create: if isAdmin();
        // 不允許刪除
        allow delete: if false;
      }
    }

    // 服務項目集合
    match /services/{serviceId} {
      // 任何人都可以讀取服務項目
      allow read: if true;
      // 僅管理員可寫入 (建立、更新、刪除)
      allow write: if isAdmin();
    }

    // 服務分類集合 (新增)
    match /serviceCategories/{categoryId} {
      // 任何人都可以讀取服務分類 (用於預約頁面顯示)
      allow read: if true;
      // 僅管理員可寫入 (建立、更新、刪除)
      allow write: if isAdmin();
    }

    // 預約集合
    match /bookings/{bookingId} {
      // 管理員可讀取任何預約；使用者僅能讀取自己的
      allow get: if isAuthenticated() && (isAdmin() || resource.data.userId == request.auth.uid);
      // 任何已登入使用者都可執行查詢 (安全性由前端 where 條件保證)
      allow list: if isAuthenticated();
      // 使用者僅能為自己建立預約
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // 使用者可取消自己的預約；管理員可更新任何預約
      allow update: if isAuthenticated() && ((resource.data.userId == request.auth.uid && request.resource.data.status == 'cancelled') || isAdmin());
      // 不允許刪除預約記錄
      allow delete: if false;
    }

    // 營業時間集合
    match /businessHours/{dateId} {
      // 任何已登入使用者都可讀取營業時間 (用於預約頁面)
      allow read: if isAuthenticated();
      // 僅管理員可寫入
      allow write: if isAdmin();
    }
    
    match /coupons/{couponId} {
      // 任何已登入使用者都可以讀取優惠券資訊
      allow read: if isAuthenticated();
      // 僅管理員可寫入 (建立、更新、刪除)
      allow write: if isAdmin();
    }
    
    match /loyaltyPointLogs/{logId} {
      // 僅管理員可建立紀錄
      allow create: if isAdmin();
      // 不允許讀取、更新、刪除
      allow read, update, delete: if false;
    }

    match /banners/{bannerId} {
      // 任何人都可以讀取 Banner (用於首頁顯示)
      allow read: if true;
      // 僅管理員可寫入 (建立、更新、刪除)
      allow write: if isAdmin();
    }

    // 作品集項目
    match /portfolioItems/{itemId} {
      // 任何人都可以讀取作品集 (用於公開頁面)
      allow read: if true;
      // 僅管理員可寫入
      allow write: if isAdmin();
    }

    // --- 以下為未來可能使用的集合，暫時保留 ---

    match /schedules/{scheduleId} {
      allow read: if true;
      allow write: if false;
    }

    match /settings/{settingId} {
      allow read, write: if isAdmin();
    }

    match /globals/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}