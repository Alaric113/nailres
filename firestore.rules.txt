rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =============================================
    //           輔助函式 (Helper Functions)
    // =============================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isDesigner() {
      return isAuthenticated() && getUserRole() == 'designer';
    }
    
    function isStaff() {
      return isAuthenticated() && (getUserRole() == 'admin' || getUserRole() == 'manager' || getUserRole() == 'designer');
    }

    // =============================================
    //           集合規則 (Collection Rules)
    // =============================================

    // 使用者集合
    match /users/{userId} {
      // 管理員和設計師可讀取任何使用者資料 (用於查看客戶資料)；使用者僅能讀取自己的
      allow get: if isAuthenticated() && (isStaff() || request.auth.uid == userId);
      // 管理員和設計師可列出所有使用者
      allow list: if isStaff();
      // 使用者可建立自己的文件，但角色必須是 'user'
      allow create: if isAuthenticated() && request.auth.uid == userId && request.resource.data.role == 'user';
      // 使用者可更新自己除了 'role' 以外的資料；管理員可更新任何資料；設計師僅能更新自己的資料
      allow update: if (isAuthenticated() && request.auth.uid == userId && !('role' in request.resource.data)) || isAdmin();
      // 不允許刪除使用者文件
      allow delete: if false;

      // 使用者優惠券子集合
      match /userCoupons/{userCouponId} {
        allow read, list: if isAuthenticated() && (request.auth.uid == userId || isStaff());
        allow update: if isAuthenticated() && (request.auth.uid == userId || isStaff());
        allow create: if isStaff(); // 允許員工發放
        allow delete: if isAdmin();
      }
    }

    // 設計師集合 (新增)
    match /designers/{designerId} {
      // 所有人可讀取設計師列表 (預約頁面需要)
      allow read: if true;
      // 僅管理員可建立或刪除設計師檔案
      allow create, delete: if isAdmin();
      // 更新規則：
      // 1. 管理員可以更新任何欄位
      // 2. 設計師只能更新「連結到自己帳號」的檔案，且不能修改 linkedUserId 本身 (防止竊取其他檔案)
      allow update: if isAdmin() || (
        isAuthenticated() && 
        resource.data.linkedUserId == request.auth.uid && 
        request.resource.data.linkedUserId == resource.data.linkedUserId
      );
    }

    // 服務項目集合
    match /services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin(); // 服務項目仍由管理員統一管理
    }

    // 服務分類集合
    match /serviceCategories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 預約集合
    match /bookings/{bookingId} {
      // 管理員與設計師可讀取任何預約 (未來可細分只能讀取自己的)；使用者僅能讀取自己的
      allow get: if isAuthenticated() && (isStaff() || resource.data.userId == request.auth.uid);
      allow list: if isAuthenticated(); // 前端過濾
      
      // 使用者僅能為自己建立預約；員工可為客戶建立
      allow create: if isAuthenticated() && (request.resource.data.userId == request.auth.uid || isStaff());
      
      // 使用者可取消自己的預約；員工可更新預約狀態
      allow update: if isAuthenticated() && (
        (resource.data.userId == request.auth.uid && request.resource.data.status == 'cancelled') || 
        isStaff()
      );
      
      allow delete: if false;
    }

    // 全域營業時間集合 (預設營業時間)
    match /businessHours/{dateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // 優惠券
    match /coupons/{couponId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // 點數紀錄
    match /loyaltyPointLogs/{logId} {
      allow create: if isStaff(); // 允許員工操作點數
      allow read: if isStaff() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow update, delete: if false;
    }

    match /banners/{bannerId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /portfolioItems/{itemId} {
      allow read: if true;
      // 設計師也可以上傳作品
      allow write: if isStaff();
    }

    match /schedules/{scheduleId} {
      allow read: if true;
      allow write: if false;
    }

    match /settings/{settingId} {
      allow read, write: if isAdmin();
    }

    match /globals/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
